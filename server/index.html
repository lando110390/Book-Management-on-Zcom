<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Book Management</title>
    <meta name="description" content="Demo contract with zcom blockchain">
    <link href="./public/css/bootstrap.min.css" rel="stylesheet">
    <link href="./public/css/style.css" rel="stylesheet">
</head>
<body>

    <div class="container-fluid">
        <div class="row" id="inputWrap">
            <div class="col-md-12">
                <h3>Add/Edit Book</h3>

                <form role="form" id="input-form">
                    <div class="form-group">
                        <label for="bookTitle">Title</label>
                        <input type="text" class="form-control" id="bookTitle">
                    </div>
                    <div class="form-group">
                        <label for="bookImg">Image</label>
                        <input type="file" id="bookImg">
                    </div>
                    <button type="submit" class="btn btn-primary" id="btnAdd">Add</button>
                    <button type="submit" class="btn btn-primary" id="btnUpdate">Save</button>
                    <button type="submit" class="btn btn-danger" id="btnCancel">Cancel</button>
                </form>
            </div>

        </div>

        <div class="row" id="listWrap">
            <div class="col-md-12">
                <h3>List</h3>

                <div class="row item-wrap sample" style="display: none">
                    <div><strong class="title">This is a title</strong></div>
                    <div><img alt="Bootstrap Image Preview" src="" class="img-thumbnail"></div>
                    <button type="button" class="btn btn-primary btn-xs btn-edit">Edit</button>
                    <button type="button" class="btn btn-danger btn-xs btn-delete">Remove</button>
                    <input type="hidden" value="" name="bookId" class="bookId">
                </div>

                <div id="bookList"></div>

            </div>
        </div>
    </div>
    <div class="loading">Loading&#8230;</div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
    <script src="./public/js/bootstrap.min.js"></script>
    <script src="./public/js/eth-client.js"></script>
    <script src="./abi.js"></script>
    <script src="./public/js/local-storage.js"></script>
    <script src="./public/js/demo-util.js"></script>
	<script src="//cdn.jsdelivr.net/bluebird/3.5.0/bluebird.js"></script>
	<script src="./public/js/web3.js"></script>

    <script>
		const MAX_COUNTDOWN = 5;
        const cnsAddress = '0x99ce35d31aed121de342aa05b4934825a0e51a21';
        const baseUrl = 'https://api.blockchain.z.com/';
        const abi = BOOK_ABI;
        var password = '123456';
        var account;
        var contract;
        var registerBookId;
		var web3 = new Web3();

//registerBookId:  0jAxwoHWzgY107VRCmGXm2s25fusTs23
//registerdObjectId:  Xn0nYcyo1vMcUvbdAM3XFyt9OOGtK0iK
//fileName:  1.txt
//--------------- sendFile - start 
// *** ERR ***  null
// *** res ***  0x144b7d7bf8505eb679e491c8ae2278d399184725aa3570d0993ad065cc62cc30		
		
		
		
        function init() {
            $('#btnUpdate').hide();
            $('#btnCancel').hide();
            var userAccount = LOCAL_STORAGE.getAccount();
            if (userAccount) {
                contract = new ethClient.AltExecCnsContract(userAccount, cnsAddress);
                getAllBooks();
				$('#loading').hide();
				
				/*contract.getFile(password, 'BookContract', 'getImgFile', ['dOPQaOYIpzawD3vheFCYD7GScSTEiLsg'], abi, function(err, res) {
					console.log('*** ERR *** ', err);
					console.log('*** res *** ', res);
					var link = document.createElement("a");
					document.body.appendChild(link);
					link.href = window.URL.createObjectURL(res);
					link.download = res.name;
					link.click();
					window.URL.revokeObjectUrl(link.href);
					document.body.removeChild(link);
				});*/
				
				/*setTimeout(function() {
					console.log('--------------- updateFile - start ');
					let input = document.getElementById('bookImg');
					contract.updateFile(password, 'BookContract', 'updateImgFile', 'dOPQaOYIpzawD3vheFCYD7GScSTEiLsg', input.files[0], ['ZrSFn92KeAwNQO4Ftkmkj8XuZtH8I13u'], abi, function(err, res) {
						console.log('*** ERR *** ', err);
						console.log('*** res *** ', res);
					});
					
					registerBookId = DEMO_UTIL.createRandomId(32);
					const registerdObjectId = DEMO_UTIL.createRandomId(32);
					const fileName = $('input[type=file]').val().split('\\').pop();
					let input = document.getElementById('bookImg');
					
					console.log('registerBookId: ', registerBookId);
					console.log('registerdObjectId: ', registerdObjectId);
					console.log('fileName: ', fileName);
					console.log('--------------- sendFile - start ');
					contract.sendFile(password, 'BookContract', 'setImgFile', registerdObjectId, fileName, input.files[0], [registerBookId], abi, function(err, res) {
						console.log('*** ERR *** ', err);
						console.log('*** res *** ', res);
						
					});
				}, 10000)*/
				
				
				
				
				
				//contract.updateData(password, 'BookContract', 'updateTitleData', '2ViEUh1Tzo9p5TVwy2MKBqHp454EKA02', 'ppppppppppppp', ['v6wsEwsDOhCLxd77odFj57pK5oHPMOmw'], abi, function(err, txHash) {
				//	console.log('-------------- updateData');
				//	if (err) console.error(err);
				//	else console.log(txHash);
				//});
				//_bookId 0x553074474e7775416e444556584f47364e73524f614f48517171496551435644
				//dataObjectId 0x3637794c5a4f4830363947687167664c4b3668424c5150367848346173577246
				//fileObjectId 0x70504d515744676164553669354d6b4c7070636479336f54555a4d5231664737
				
            } else {
                ethClient.Account.create(baseUrl, password, function(err, _account) {
                    if (err) console.log(err);
                    else {
                        account = _account;
                        LOCAL_STORAGE.setAccount(_account);
                        contract = new ethClient.AltExecCnsContract(account, cnsAddress);
                    }
                })
            }
        }
		
		function getTransactionReceiptLoop(txHash) {
			let count = 0;
			return new Promise(function(resolve, reject) {
                let setIntervalPoint = setInterval(function(){ 
					contract.getTransactionReceipt(txHash, function (err, receipt) {
						if (receipt || count == MAX_COUNTDOWN) {
							clearInterval(setIntervalPoint);
							resolve(receipt);
						} else ++count;
					});
				}, 1000);
            });
		}

        function setBookId(_bookId) {
            return new Promise(function(resolve, reject) {
                return contract.sendTransaction(password, 'BookContract', 'setBookId', [_bookId], abi, function(err, res) {
                    if (err) reject(err);
                    else resolve(res);
                });
            })
        }

        function setTitleData(_bookId) {
            const registerdObjectId = DEMO_UTIL.createRandomId(32);
            let registerdData = $('#bookTitle').val();
            return new Promise(function(resolve, reject) {
                return contract.sendData(password, 'BookContract', 'setTitleData', registerdObjectId, registerdData, [_bookId], abi, function(err, res) {
                    if (err) reject(err);
                    else resolve(res);
                });
            });
        }

        function updateTitleData(_dataObjectId, _bookId) {
            let registerdData = $('#bookTitle').val();
            return new Promise(function(resolve, reject) {
                return contract.updateData(password, 'BookContract', 'updateTitleData', _dataObjectId, registerdData, [_bookId], abi, function(err, res) {
                    if (err) reject(err);
                    else resolve(res);
                });
            });
        }

        function setImgFile(_bookId) {
            const registerdObjectId = DEMO_UTIL.createRandomId(32);
            const fileName = $('input[type=file]').val().split('\\').pop();
            let input = document.getElementById('bookImg');

            return new Promise(function(resolve, reject) {
                return contract.sendFile(password, 'BookContract', 'setImgFile', registerdObjectId, fileName, input.files[0], [_bookId], abi, function(err, res) {
                    if (err) reject(err);
                    else resolve(res);
                });
            })
        }

        function updateImgFile(_fileObjectId, _bookId) {
            let input = document.getElementById('bookImg');

            return new Promise(function(resolve, reject) {
                return contract.updateFile(password, 'BookContract', 'updateImgFile', _fileObjectId, input.files[0], [_bookId], abi, function(err, res) {
                    if (err) reject(err);
                    else resolve(res);
                });
            });
        }

        function getTitleData(_dataObjectId) {
            return new Promise(function(resolve, reject) {
                return contract.getData(password, 'BookContract', 'getTitleData', [_dataObjectId], abi, function(err, res) {
                    if (err) reject(err);
                    else resolve(res[0]);
                });
            });
        }

        function getImgFile(_fileObjectId) {
            return new Promise(function(resolve, reject) {
                return contract.getFile(password, 'BookContract', 'getImgFile', [_fileObjectId], abi, function(err, res) {
                    if (err) reject(err);
                    else resolve(res);
                });
            });
        }

        function getBookWithID(_bookId) {
            return new Promise(function(resolve, reject) {
                return contract.call(password, 'BookContract', 'getBookWithID', [_bookId], abi, function(err, res) {
                    if (err) reject(err);
                    else resolve(res);
                });
            })
        }

        function getIdBookList() {
            return new Promise(function(resolve, reject) {
                return contract.call(password, 'BookContract', 'getIdBookList', [], abi, function(err, res) {
                    if (err) reject(err);
                    else resolve(res[0]);
                });
            })
        }

        function addNewBook() {
            registerBookId = DEMO_UTIL.createRandomId(32);
            return Promise.all([setBookId(registerBookId), setTitleData(registerBookId), setImgFile(registerBookId)])
                .then(function([txHashId, txHashData, txHashImg]) {
					return Promise.all([getTransactionReceiptLoop(txHashData), getTransactionReceiptLoop(txHashImg)]).then(([receiptData, receiptImg]) => {
						setTimeout(function() {
							appendBook(registerBookId).then(() => {
								$('.loading').hide();
								$('#btnAdd').removeClass('disabled');
							});
						}, 5000);
					})
					
                })
        }

        var currentBookSelected;
		var rowBookSelected;
        function editTheBook(book, row) {
            $('#bookTitle').val(row.find('.title').text());
            $('#btnAdd').hide();
            $('#btnUpdate').show();
            $('#btnCancel').show();
            currentBookSelected = book;
            rowBookSelected = row;
        }

        function updateTheBook() {
            updateTitleData(web3.toAscii(currentBookSelected[1]), currentBookSelected[0]).then(function(txHashData) {
                if (document.getElementById("bookImg").files.length > 0) {
                    updateImgFile(web3.toAscii(currentBookSelected[2]), currentBookSelected[0]).then(function(txHashFile) {
                        Promise.all([getTransactionReceiptLoop(txHashData), getTransactionReceiptLoop(txHashFile)]).then(([receiptData, receiptImg]) => {
							setTimeout(function() {
								rowBookSelected.remove();
								appendBook(currentBookSelected[0]).then(() => {
									$('.loading').hide();
									$('#btnAdd').removeClass('disabled');
								});
							}, 5000);
						})
                    })
                } else {
					Promise.all([getTransactionReceiptLoop(txHashData)]).then(([receiptData]) => {
						setTimeout(function() {
							rowBookSelected.remove();
							appendBook(currentBookSelected[0]).then(() => {
								rowBookSelected.remove();
								$('.loading').hide();
								$('#btnAdd').removeClass('disabled');
							});
						}, 5000);
					})
				}
            })
        }

        function appendBook(_bookId) {
			return new Promise(function(resolve, reject) {
                return getBookWithID(_bookId).then(function(book) {
					let dataObjectId = web3.toAscii(book[1]),
						fileObjectId = web3.toAscii(book[2]);
					return getTitleData(dataObjectId).then(function(objTitle) {
						console.log(objTitle);
						if (objTitle.status == 200) {
							var title = objTitle.data;
							return getImgFile(fileObjectId).then(function(objImg) {
								var row = $("[class*='sample']").clone();
								row.removeClass('sample');
								row.find('.title').text(title);
								row.find('.img-thumbnail').attr('src', window.URL.createObjectURL(objImg));
								row.find('.btn-edit').click(function(e) {
									editTheBook(book, row);
								});
								row.find('.btn-delete').click(function(e) {
									alert('この関数が開発られています。');
								});
								row.find('.bookId').val(_bookId);
								row.show();

								row.prependTo('#bookList');
								resolve();
							})
						} else resolve();
					})
				});
            });
        }

        function getAllBooks() {
            $('.loading').show();
            return getIdBookList().then(function(bookList) {
                $('#bookList').html('');

                let fetchBookIds = function(_bookList) {
                    return _bookList.reduce(function(promise, bookId) {
                        return promise.then((result) => {
                            return appendBook(bookId)
                        });
                    }, Promise.resolve());
                }

                return fetchBookIds(bookList).then(() => {
                    $('.loading').hide();
                });
            });
        }

        $('#btnAdd').click(function(e) {
            if ($(this).hasClass('disabled')) return false;
            e.preventDefault();
            if (!$('#bookTitle').val()) { alert('Input Book Title'); return false; }
            if (!$('#bookImg').val()) { alert('Input Book Image'); return false; }
            $(this).addClass('disabled');
            $('.loading').show();
            addNewBook();
        });

        $('#btnUpdate').click(function(e) {
            e.preventDefault();
            if (!$('#bookTitle').val()) { alert('Input Book Title'); return false; }
            $(this).addClass('disabled');
            $('.loading').show();
            updateTheBook();
        });

        $('#btnCancel').click(function(e) {
            e.preventDefault();
            $(this).hide();
            $('#btnUpdate').hide();
            $('#btnAdd').show();
            $('#bookTitle').val('');
            $('#bookImg').val('');
        });

        init();
    </script>
</body>

</html>
